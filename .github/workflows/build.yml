name: Build Cordova App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Install Cordova
        run: npm install -g cordova

      - name: Copy config.xml
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > config.xml
          echo '<widget id="com.niced.firstapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">' >> config.xml
          echo '  <name>Kichu Pottan</name>' >> config.xml
          echo '  <description>Your app description</description>' >> config.xml
          echo '  <author email="your-email@example.com" href="https://your-website.com">Your Name</author>' >> config.xml
          echo '' >> config.xml
          echo '  <!-- Android platform-specific configurations -->' >> config.xml
          echo '  <platform name="android">' >> config.xml
          echo '    <preference name="orientation" value="landscape" />' >> config.xml
          echo '' >> config.xml
          echo '    <!-- App Icon -->' >> config.xml
          echo '    <icon src="res/icon.png" />' >> config.xml
          echo '' >> config.xml
          echo '    <!-- App Preferences -->' >> config.xml
          echo '    <preference name="android-targetSdkVersion" value="29" />' >> config.xml
          echo '    <!-- Add more preferences as needed -->' >> config.xml
          echo '' >> config.xml
          echo '    <!-- Permissions -->' >> config.xml
          echo '    <config-file parent="/*" target="AndroidManifest.xml">' >> config.xml
          echo '      <uses-permission android:name="android.permission.CAMERA" />' >> config.xml
          echo '      <!-- Add more permissions as needed -->' >> config.xml
          echo '    </config-file>' >> config.xml
          echo '  </platform>' >> config.xml
          echo '  <content src="index.html" />' >> config.xml
          echo '</widget>' >> config.xml

      - name: Build Cordova project
        run: |
          cordova create myApp
          cd myApp
          cp ../config.xml .
          cordova platform add android
          cordova build android --release -- --packageType=bundle

      - name: Install JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '14'

      - name: Download Bundletool
        run: |
          wget -O bundletool.jar https://github.com/google/bundletool/releases/download/1.15.1/bundletool-all-1.15.1.jar

      - name: Generate APK
        run: |
          java -jar bundletool.jar build-apks --bundle=platforms/android/app/build/outputs/bundle/release/app-release.aab --output=app-release.apks --mode=universal

      - name: Extract APK from APK Set
        run: |
          unzip -j app-release.apks 'universal.apk' -
